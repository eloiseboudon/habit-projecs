-- init_seed_habit.sql
-- Ins√®re les donn√©es de d√©marrage dans le sch√©ma habit

SET search_path TO habit, public;

-- DOMAINS
INSERT INTO domains (id, key, name, icon, order_index) VALUES
  (1, 'health',    'Sant√© & Sport',        'üí™', 1),
  (2, 'work',      'Travail & Projets',    'üíº', 2),
  (3, 'money',     'Finances',             'üí∞', 3),
  (4, 'mindset',   'Esprit & Connaissance','üß†', 4),
  (5, 'relations', 'Relations & Social',   'ü§ù', 5),
  (6, 'home',      'Maison & Vie perso',   'üè°', 6)
ON CONFLICT (id) DO NOTHING;

-- REWARDS
INSERT INTO rewards (id, title, cost_xp, is_active) VALUES
  (1, 'Badge Bronze', 100, true),
  (2, 'Badge Argent', 250, true),
  (3, 'Badge Or',     500, true)
ON CONFLICT (id) DO NOTHING;

-- TASK TEMPLATES
-- (corrig√© : virgule manquante apr√®s la 2e ligne + unit√©s coh√©rentes)
INSERT INTO task_templates (id, title, domain_id, default_xp, default_points, unit, is_active) VALUES
  (1,  'S√©ance de sport (45 min)',             1, 10, 10, 'min', true),
  (2,  'Boire 2L d‚Äôeau',                       1, 5,  5,  'L',   true),
  (3,  'Avancer un projet pro',                2, 10, 10, NULL,  true),
  (4,  'Apprendre une nouvelle comp√©tence',    2, 15, 15, NULL,  true),
  (5,  '√âpargner 20 ‚Ç¨',                        3, 10, 10, '‚Ç¨',   true),
  (6,  'Suivi budget perso',                   3, 5,  5,  NULL,  true),
  (7,  'Lecture 30 min',                       4, 10, 10, 'min', true),
  (8,  'M√©ditation 10 min',                    4, 5,  5,  'min', true),
  (9,  'Appeler un ami',                       5, 10, 10, NULL,  true),
  (10, 'Soir√©e en famille',                    5, 15, 15, NULL,  true),
  (11, 'Rangement 15 min',                     6, 5,  5,  'min', true),
  (12, 'Pr√©parer ses repas',                   6, 10, 10, NULL,  true)
ON CONFLICT (id) DO NOTHING;

-- (Optionnel) r√©alignement des s√©quences/identities sur le max(id)
-- Utile si tes colonnes id sont en GENERATED BY DEFAULT/ALWAYS AS IDENTITY
DO
$$
DECLARE
    rec RECORD;
    seq_name text;
    max_id bigint;
BEGIN
    FOR rec IN
        SELECT 'domains' AS tbl
        UNION ALL SELECT 'rewards'
        UNION ALL SELECT 'task_templates'
    LOOP
        -- R√©cup√©rer la s√©quence li√©e (fonctionne pour SERIAL/IDENTITY)
        SELECT pg_get_serial_sequence('habit.' || rec.tbl, 'id') INTO seq_name;
        IF seq_name IS NOT NULL THEN
            EXECUTE format('SELECT COALESCE(MAX(id), 0) FROM habit.%I', rec.tbl) INTO max_id;
            EXECUTE format('SELECT setval(%L, %s, true);', seq_name, max_id);
        END IF;
    END LOOP;
END
$$;
